<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kerberos</title>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <div class="container">

    <div class="as-tgs-wrapper">
      <section class="as__section">
        <div class="as__section-input-group">
          <input type="text" id="username" placeholder="Username" value="alice">
          <input type="password" id="password" placeholder="Password" value="password123">
          <button class="button" onclick="authenticate()">Log in</button>
        </div>

        <div class="as__result">

        </div>
      </section>

      <section class="tgs__section">
        <div class="elements-wrapper">
          <select class="tgs__service-select">
            <option value="files">File Service</option>
            <!-- <option value="email">Email Service</option>
            <option value="print">Print Service</option> -->
          </select>
          <button class="button" onclick="requestServiceTicket()">Get Service Ticket</button>
        </div>

        <div class="tgs__result">

        </div>
      </section>
    </div>


    <!-- <section class="check-tgt__section">
      <div>
        <input type="text" id="tgt-id" placeholder="ID TGT" readonly">
        <button onclick="validateTGT()">Check TGT</button>
      </div>

      <div class="check-tgt__result">
        Result
      </div>
    </section> -->


    <section class="file-service__section">
      <div class="files-wrapper">
        <div class="button-wrapper">
          <button class="button" onclick="accessFiles()">Get My Files</button>
        </div>
        <div id="files-result" class="debug"></div>
        <div id="files-list"></div>
      </div>
    </section>

    <div class="debug-wrapper">
      <section class="as-debug__section">
        <button class="button" onclick="showDebugInfo()">Show TGT</button>
        <div class="as-debug__result">

        </div>
      </section>

      <section class="tgs-debug__section">
        <button class="button" onclick="showTGSInfo()">Show TGS tickets</button>
        <div class="tgs-debug__result">

        </div>
      </section>
    </div>

    <!-- ========================= -->

    <!-- <button onclick="window.location.href='/attacks'" style="margin-top: 20px; background: #dc3545;">
      Test Attacks â†’
    </button> -->


  </div>

  <script>
    let currentTGT = null;
    let currentServiceTicket = null;
    let currentServiceSessionKey = null;
    let currentUsername = null;

    async function authenticate() {
      const username = document.querySelector('#username').value;
      const password = document.querySelector('#password').value;
      const resultDiv = document.querySelector('.as__result');

      currentUsername = username;

      resultDiv.innerHTML = '<div class="debug">Request to AS...</div>';

      try {
        const response = await fetch('/api/authenticate', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            username: username,
            password: password
          })
        });

        const data = await response.json();

        if (data.success) {
          currentTGT = data.data.tgt;

          resultDiv.innerHTML = `
            <div class="success">
              <span class="icon"></span>
              <div class="debug">
                <strong>User:</strong> ${username}<br>
                <strong>TGT ID:</strong> ${data.data.tgt.id}<br>
                <strong>Session key:</strong> ${data.data.sessionKey.substring(0, 20)}...
              </div>
            </div>
          `;

          // document.querySelector('.check-tgt__result').innerHTML =
          //   '<div class="success">TGT is here</div>';
        } else {
          resultDiv.innerHTML = `
            <div class="error">
              <strong>Error:</strong> ${data.message}
            </div>
          `;
        }

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>NETWORK error:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function validateTGT() {
      const tgtId = document.querySelector('#tgt-id').value;
      const resultDiv = document.querySelector('.check-tgt__result');

      resultDiv.innerHTML = '<div class="debug">Requeest to check TGT...</div>';

      try {
        const response = await fetch('/api/validate-tgt', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            tgtId: tgtId
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
            <div class="success">
              <strong>TGT valid</strong>
              <div class="debug">
                <strong>User:</strong> ${data.data.username}<br>
                <strong>Session Key:</strong> ${data.data.sessionKey.substring(0, 20)}...
              </div>
            </div>
          `;


        } else {
          resultDiv.innerHTML = `
            <div class="error">
              <strong>TGT invalid:</strong> ${data.message}
            </div>
          `;
        }

      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>Error:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function showDebugInfo() {
      const resultDiv = document.querySelector('.as-debug__result');

      try {
        const response = await fetch('/api/debug/tickets');
        const data = await response.json();

        let debugHTML = '<div class="debug"><strong><p class="debug-title">Active TGT:</p></strong>';

        if (data.count === 0) {
          debugHTML += 'No active TGT';
        } else {
          for (const [tgtId, ticket] of Object.entries(data.tickets)) {
            const timeAgo = Math.round((new Date() - new Date(ticket.issuedAt)) / 1000 / 60);
            debugHTML += `
              <hr>
              <strong>ID:</strong> ${tgtId.substring(0, 16)}...<br>
              <strong>User:</strong> ${ticket.username}<br>
              <strong>Issue:</strong> ${timeAgo} minutes ago<br>
              <strong>Session key:</strong> ${ticket.sessionKey.substring(0, 16)}...
            `;
          }
        }

        debugHTML += '</div>';
        resultDiv.innerHTML = debugHTML;

      } catch (error) {
        resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    async function requestServiceTicket() {
      if (!currentTGT) {
        alert('Firstly use TGT');
        return;
      }

      const serviceName = document.querySelector(".tgs__service-select").value;
      const resultDiv = document.querySelector(".tgs__result");

      resultDiv.innerHTML = '<div class="debug">Request to TGS...</div>';

      try {
        const response = await fetch('/api/request-service-ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            tgtId: currentTGT.id,
            serviceName: serviceName
          })
        });

        const data = await response.json();

        if (data.success) {
          currentServiceTicket = data.data.serviceTicket;
          currentServiceSessionKey = data.data.serviceSessionKey;

          resultDiv.innerHTML = `
            <div class="success special">
              <span class="icon"></span>
              <div class="debug">
              <strong>ticket ID:</strong> ${data.data.serviceTicket.id}<br>
              <strong>Issue:</strong> ${new Date(data.data.expiresAt).toLocaleTimeString()}<br>
              <strong>Service key:</strong> ${data.data.serviceSessionKey.substring(0, 20)}...<br>
              </div>
            </div>
          `;

        } else {
          resultDiv.innerHTML = `<div class="error">TGS error: ${data.message}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
      }
    }

    async function showTGSInfo() {
      const resultDiv = document.querySelector(".tgs-debug__result");

      try {
        const response = await fetch('/api/debug/tgs');
        const data = await response.json();

        let html = '';

        if (data.issuedTicketsCount > 0) {
          html += '<div class="debug"><strong><p class="debug-title">Active service tickets:</p></strong>';
          for (const [id, ticket] of Object.entries(data.activeTickets)) {
            html += `
              <hr>
              <strong>ID:</strong> ${id.substring(0, 20)}...<br>
              <strong>User:</strong> ${ticket.username}<br>
              <strong>Service:</strong> ${ticket.serviceName}<br>
              <strong>Issued:</strong> ${new Date(ticket.issuedAt).toLocaleTimeString()}<br>
  <strong>Expires:</strong> ${new Date(new Date(ticket.issuedAt).getTime() + 5 * 60000).toLocaleTimeString()}<br>
            `;
          }
        }

        html += '</div>';
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
      }
    }

    async function accessFiles() {
      if (!currentServiceTicket) {
        alert('Firstly get service ticket!');
        return;
      }

      const resultDiv = document.querySelector('#files-result');
      const filesListDiv = document.querySelector('#files-list');

      resultDiv.innerHTML = 'Request...';
      filesListDiv.style.display = 'none';

      try {
        const authData = {
          username: currentUsername,
          timestamp: new Date().toISOString(),
          random: crypto.randomBytes
            ? crypto.randomBytes(8).toString('hex')
            : Math.random().toString(36).substring(2)
        };

        const encryptedAuthenticator = encryptWithKey(
          JSON.stringify(authData),
          currentServiceSessionKey
        );

        const response = await fetch('/api/access-files', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            encryptedTicket: currentServiceTicket.encrypted,
            authenticator: encryptedAuthenticator
          })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.innerHTML = `
        <div class="success">
          
        </div>
      `;

          let filesHTML = '<p class="files-title"><strong>Your files:</strong></p><table border="1">';
          filesHTML += '<tr><th>FileName</th><th>Size</th><th>Changed</th></tr>';

          data.files.forEach(file => {
            filesHTML += `
          <tr>
            <td>${file.name}</td>
            <td>${file.size}</td>
            <td>${file.modified}</td>
          </tr>
        `;
          });

          filesHTML += '</table>';
          filesListDiv.innerHTML = filesHTML;
          filesListDiv.style.display = 'block';

        } else {
          resultDiv.innerHTML = `<div class="error">Access error: ${data.message}</div>`;
        }
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">Network error: ${error.message}</div>`;
      }
    }

    function encryptWithKey(text, key) {
      let encrypted = '';
      for (let i = 0; i < text.length; i++) {
        const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
        encrypted += String.fromCharCode(charCode);
      }
      return btoa(encrypted);
    }

    document.addEventListener('DOMContentLoaded', function () {
      console.log('Kerberos demonstration');
    });
  </script>

</body>

</html>